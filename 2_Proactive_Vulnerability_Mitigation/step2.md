#### Install runsc on Each Node

- Update packages and install prerequisites
```bash
sudo apt-get update && \
sudo apt-get install -y \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg
```{{exec}}

- Add the gVisor apt repository key and repo
```bash
curl -fsSL https://gvisor.dev/archive.key | sudo gpg --dearmor -o /usr/share/keyrings/gvisor-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/gvisor-archive-keyring.gpg] https://storage.googleapis.com/gvisor/releases release main" | sudo tee /etc/apt/sources.list.d/gvisor.list > /dev/null
```{{exec}}


- Install runsc:
```bash
sudo apt-get update && sudo apt-get install -y runsc
```{{exec}}

#### Configure containerd
Next, still on each node, you need to tell containerd about the new runsc runtime.

- Edit the containerd config file (usually at /etc/containerd/config.toml). 

```bash
nano /etc/containerd/config.toml
```{{exec}}

- Add the runsc runtime handler. Find the `[plugins."io.containerd.grpc.v1.cri".containerd.runtimes]` section. 
You will see an entry for runc (the default). Add a new entry for runsc alongside it:

```
# Make sure to place this under the [plugins."io.containerd.grpc.v1.cri".containerd] section

[plugins."io.containerd.grpc.v1.cri".containerd.runtimes]
  # This is the default runtime
  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
    runtime_type = "io.containerd.runc.v2"
    [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
      SystemdCgroup = true

  # Add this block for gVisor (runsc)
  [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runsc]
    runtime_type = "io.containerd.runsc.v1"
```

- Restart containerd to apply the changes
```bash
sudo systemctl restart containerd
```{{exec}}

- Create runtime class
```bash
cat <<EOF | kubectl apply -f -
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: gvisor  # This is the name you'll use in your Pod specs
handler: runsc  # This must match the handler name in config.toml
EOF
```{{exec}}


- Create a new pod using gvisor runtime

```bash
cat <<EOF | kubectl apply -f -
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-default
spec:
  containers:
  - name: nginx
    image: nginx
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-gvisor
spec:
  runtimeClassName: gvisor  # This tells K8s to use your new RuntimeClass
  containers:
  - name: nginx
    image: nginx

EOF
```{{exec}}


- Verify the difference

Test the default pod:
```bash

kubectl exec -it pod-default -- dmesg
```{{exec}}

You will see an error, as a standard, unprivileged container cannot access the host's kernel messages: dmesg: klogctl: Operation not permitted

Test the gVisor-sandboxed pod:

```bash

kubectl exec -it pod-gvisor -- dmesg
```{{exec}}

You will see the output from gVisor's own sandboxed kernel.
This confirms that your pod-gvisor pod is running inside the gVisor sandbox, successfully isolated from the host kernel.