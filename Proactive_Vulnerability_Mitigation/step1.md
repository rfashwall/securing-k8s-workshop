#### K8s Secret Management

##### Creating and Consuming Secrets

1. Create the Secret: Execute the following command to create the secret:

`kubectl apply -f 01-secret.yaml`{{exec}}
    
2. Create the Pod: Deploy the pod that consumes this secret with:
    
`kubectl apply -f 02-pod-secret.yaml`{{exec}}

#### Enhanced Secret Management with HashiCorp Vault

Setup and Usage

1. Add HashiCorp Repo and Install Vault Chart:

```
helm repo add hashicorp https://helm.releases.hashicorp.com
helm repo update
helm upgrade --install vault hashicorp/vault -n vault --create-namespace --values vault/vault-values.yaml
```{{exec}}
    
2. Access Vault CLI:

`
kubectl exec --stdin=true --tty=true vault-0 -n vault -- /bin/sh`{{exec}}

3.  Enable Kubernetes Auth Method:

`vault auth enable -path securing-k8s kubernetes`{{exec}}
    
4.  Configure Kubernetes Auth Method:

```
vault write auth/securing-k8s/config \
    kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
```{{exec}}
    
5.  Enable KV v2 Secrets Engine:

`vault secrets enable -path=k8s-dev kv-v2`{{exec}}
    
6.  Create Read-only Policy:

```
vault policy write dev - <<EOF
path "k8s-dev/*" {
capabilities = ["read"]
}
EOF
```{{exec}}
    
7.  Create Role:

```
vault write auth/securing-k8s/role/dev-role \
    bound_service_account_names=default \
    bound_service_account_namespaces=development \
    policies=dev \
    ttl=24h
```{{exec}}
    
8.  Create Secret in Vault:

`vault kv put k8s-dev/dev-app/config username="dev" password="dev-password"`{{exec}}


#### To Access Vault UI

1. Generate the token

`vault token create`{{exec}}

2. Port forward

`kubectl port-forward vault-0 8200:8200 -n vault` {{exec}}

#### Using Vault Secrets Operator

1. Install Vault Secrets Operator:

`helm upgrade --install vault-secrets-operator hashicorp/vault-secrets-operator -n vault --values vault/vault-operator-values.yaml`{{exec}}
    
2. Set up Kubernetes Authentication for Secret:

`kubectl apply -f vault/dev-auth.yaml`{{exec}}

3. Create Secret:
    
`kubectl apply -f vault/demo-secret.yaml`{{exec}}

Updating and Checking Secrets

4. Update Secret in Vault:

`vault kv put k8s-dev/dev-app/config username="dev" password="new-super-password" token="I am a token"`{{exec}}

5. Check the Updated Secret in the Pod: After updating the secret in Vault, verify its propagation by checking the pod consuming the secret.
