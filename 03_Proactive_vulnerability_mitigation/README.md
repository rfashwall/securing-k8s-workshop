# Proactive Vulnerability Mitigation

```
cd 03_Proactive_vulnerability_mitigation
```
## Secret Management

### K8s Secret Management

**Creating and Consuming Secrets**

1.  **Create the Secret:** Execute the following command to create the secret:
    ```
    kubectl apply -f 01-secret.yaml
    ```
    
2.  **Create the Pod:** Deploy the pod that consumes this secret with:
    
    ```bash
    kubectl apply -f 02-pod-secret.yaml
    ```

### Enhanced Secret Management with HashiCorp Vault

**Setup and Usage**

1.  **Add HashiCorp Repo and Install Vault Chart:**
    ```
    helm repo add hashicorp <https://helm.releases.hashicorp.com>
    helm repo update
    helm upgrade --install vault hashicorp/vault -n vault --create-namespace --values vault/vault-values.yaml
    ```
    
2.  **Access Vault CLI:**
    ```
    kubectl exec --stdin=true --tty=true vault-0 -n vault -- /bin/sh
    ```

3.  **Enable Kubernetes Auth Method:**
    ```
    vault auth enable -path securing-k8s kubernetes
    ```
    
4.  **Configure Kubernetes Auth Method:**
    ```
    vault write auth/securing-k8s/config \
      kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
    
    ```
    
5.  **Enable KV v2 Secrets Engine:**
    ```
    vault secrets enable -path=k8s-dev kv-v2
    ```
    
6.  **Create Read-only Policy:**
    ```
vault policy write dev - <<EOF
path "k8s-dev/*" {
capabilities = ["read"]
}
EOF
    ```
    
7.  **Create Role:**
    ```
    vault write auth/securing-k8s/role/dev-role \
       bound_service_account_names=default \
       bound_service_account_namespaces=development \
       policies=dev \
       ttl=24h
    ```
    
8.  **Create Secret in Vault:**
    ```
    vault kv put k8s-dev/dev-app/config username="dev" password="dev-password"
    ```

* **To Access Vault UI**

- Generate the token
```
vault token create
```
- Port forward
```
kubectl port-forward vault-0 8200:8200 -n vault
``` 

**Using Vault Secrets Operator**

1.  **Install Vault Secrets Operator:**
    ```
    helm upgrade --install vault-secrets-operator hashicorp/vault-secrets-operator -n vault --values vault/vault-operator-values.yaml
    ```
    
2.  **Set up Kubernetes Authentication for Secret:**
    ```
    kubectl apply -f vault/dev-auth.yaml
    ```
3.  **Create Secret:**
    
    ```
    kubectl apply -f vault/demo-secret.yaml    
    ```

**Updating and Checking Secrets**
-   **Update Secret in Vault:** 
    ```
    vault kv put k8s-dev/dev-app/config username="dev" password="new-super-password" token="I am a token"
    
    ```
-   **Check the Updated Secret in the Pod:** After updating the secret in Vault, verify its propagation by checking the pod consuming the secret.

### Sandboxes
- Access the node
```
docker exec -it securing-k8s-cluster-worker sh
```

- Install gvisor
```

(
apt-get update && \
apt-get install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common nano wget
set -e
ARCH=$(uname -m)
URL=https://storage.googleapis.com/gvisor/releases/release/latest/${ARCH}
wget ${URL}/runsc ${URL}/runsc.sha512  ${URL}/containerd-shim-runsc-v1 ${URL}/containerd-shim-runsc-v1.sha512
sha512sum -c runsc.sha512 -c containerd-shim-runsc-v1.sha512
rm -f *.sha512
chmod a+rx runsc containerd-shim-runsc-v1
mv runsc containerd-shim-runsc-v1 /usr/local/bin
)
```

- Add gviso runsc runtime
```
nano /etc/containerd/config.toml

## Add the below at the end of config file
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runsc]
  runtime_type = "io.containerd.runsc.v1"
```

- Create runtime class
```
cat <<EOF | kubectl apply -f -
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: gvisor
handler: runsc
EOF
``` 

- Create a new pod using gvisor runtime
```
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: nginx-gvisor
spec:
  runtimeClassName: gvisor
  containers:
  - name: nginx
    image: nginx
EOF
```

- Check logs of pod
```
 kubectl exec  nginx-gvisor -- dmesg
```

### Trivy

Trivy is an open-source vulnerability scanner for containers and other artifacts. It's commonly used in the context of Docker to scan container images for vulnerabilities. 

* **Install trivy cli**

```
brew install trivy
```

* **Scan Dockerfiles**
Scan the first dockerfile
```
trivy config 01.Dockerfile
```

Trivy will analyze Dockerfile and provide a report detailing any vulnerabilities found, including their severity levels and identifiers.

Scan the fixed dockerfile
```
trivy config 02.Dockerfile
```

In the last section, we will see how to integrate trivy with CI.

## References
- [Vault](https://developer.hashicorp.com/vault)
- [Vault Secret Operator](https://github.com/hashicorp/vault-secrets-operator)
- [Trivy](https://aquasecurity.github.io/trivy/v0.18.3/)
- [gVisor](https://gvisor.dev/docs/user_guide/quick_start/kubernetes//)
